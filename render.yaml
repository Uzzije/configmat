services:
  # 1. Backend API (Docker)
  - type: web
    name: configmat-backend
    runtime: docker
    repo: https://github.com/configmat/configmat # User needs to verify repo usage in Render Dashboard 
    # Context should be root if Dockerfile needs access to siblings, or backend subdir
    # Assuming standard Monorepo setup where Dockerfile is in app/backend 
    # OR we set context to "." and dockerfilePath to "app/backend/Dockerfile"
    rootDir: app/backend # Render uses this as build context
    plan: starter
    envVars:
      - key: DEBUG
        value: "false"
      - key: DATABASE_URL
        fromDatabase:
          name: configmat-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: configmat-redis
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: ALLOWED_HOSTS
        value: "configmat-backend.onrender.com"
      - key: CORS_ALLOWED_ORIGINS
        value: https://configmat-ui.onrender.com
      - key: FRONTEND_URL
        value: https://configmat-ui.onrender.com

  # 2. Worker (Dramatiq)
  - type: worker
    name: configmat-worker
    runtime: docker
    rootDir: app/backend
    dockerCommand: python manage.py rundramatiq
    plan: starter
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: configmat-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: configmat-redis
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: configmat-backend
          envVarKey: SECRET_KEY

  # 3. Frontend (Static Site)
  - type: static
    name: configmat-ui
    rootDir: app/ui
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    plan: starter
    envVars:
      - key: VITE_API_URL
        value: https://configmat-backend.onrender.com
    routes:
      - type: rewrite
        source: /api/*
        destination: https://configmat-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html

databases:
  - name: configmat-db
    databaseName: configmat
    user: configmat
    plan: starter
    region: oregon # or ohio/frankfurt, should match services

services:
  - type: redis
    name: configmat-redis
    plan: starter
    region: oregon
    ipAllowList: []
